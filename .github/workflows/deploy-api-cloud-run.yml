name: Deploy API to Cloud Run

on:
  push:
    branches:
      - main
    paths:
      - "api/**"
      - ".github/workflows/deploy-api-cloud-run.yml"
  workflow_dispatch:

concurrency:
  group: deploy-api-production
  cancel-in-progress: true

env:
  GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
  GCP_REGION: ${{ vars.GCP_REGION }}
  AR_REPOSITORY: ${{ vars.AR_REPOSITORY }}
  CLOUD_RUN_SERVICE: ${{ vars.CLOUD_RUN_SERVICE }}
  CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT: ${{ vars.CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT }}
  IMAGE_NAME: flowershop-api

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    permissions:
      contents: read
      id-token: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate required GitHub variables
        run: |
          set -euo pipefail
          missing=0
          for key in GCP_PROJECT_ID GCP_REGION AR_REPOSITORY CLOUD_RUN_SERVICE CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT; do
            if [ -z "${!key:-}" ]; then
              echo "::error::Missing GitHub repository variable: ${key}"
              missing=1
            fi
          done
          if [ -z "${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}" ]; then
            echo "::error::Missing GitHub repository variable: GCP_WORKLOAD_IDENTITY_PROVIDER"
            missing=1
          fi
          if [ -z "${{ vars.GCP_DEPLOYER_SERVICE_ACCOUNT }}" ]; then
            echo "::error::Missing GitHub repository variable: GCP_DEPLOYER_SERVICE_ACCOUNT"
            missing=1
          fi
          if [ "${missing}" -ne 0 ]; then
            exit 1
          fi

      - name: Authenticate to Google Cloud (OIDC)
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_DEPLOYER_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker auth for Artifact Registry
        run: gcloud auth configure-docker "${GCP_REGION}-docker.pkg.dev" --quiet

      - name: Build and push image
        run: |
          set -euo pipefail
          IMAGE_URI="${GCP_REGION}-docker.pkg.dev/${GCP_PROJECT_ID}/${AR_REPOSITORY}/${IMAGE_NAME}:${GITHUB_SHA}"
          docker build -f api/Dockerfile -t "${IMAGE_URI}" api
          docker push "${IMAGE_URI}"
          echo "IMAGE_URI=${IMAGE_URI}" >> "${GITHUB_ENV}"

      - name: Run Prisma migrations (optional)
        if: ${{ vars.RUN_API_MIGRATIONS == 'true' }}
        working-directory: api
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DIRECT_URL: ${{ secrets.DIRECT_URL }}
        run: |
          set -euo pipefail
          npm ci
          npx prisma migrate deploy

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v3
        with:
          service: ${{ env.CLOUD_RUN_SERVICE }}
          project_id: ${{ env.GCP_PROJECT_ID }}
          region: ${{ env.GCP_REGION }}
          image: ${{ env.IMAGE_URI }}
          flags: >-
            --allow-unauthenticated
            --service-account=${{ env.CLOUD_RUN_RUNTIME_SERVICE_ACCOUNT }}
          env_vars: |
            NODE_ENV=production
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            DIRECT_URL=${{ secrets.DIRECT_URL }}
            FIREBASE_PROJECT_ID=${{ secrets.FIREBASE_PROJECT_ID }}
            FIREBASE_CLIENT_EMAIL=${{ secrets.FIREBASE_CLIENT_EMAIL }}
            FIREBASE_PRIVATE_KEY=${{ secrets.FIREBASE_PRIVATE_KEY }}
            OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
            AI_TIMEOUT_MS=12000
            AI_RETRY_ATTEMPTS=1
            AI_MAX_PROMPT_CHARS=600
            AI_MAX_RESPONSE_TOKENS=320
            AI_MAX_CONTEXT_ITEMS=40
            AI_CACHE_TTL_MS=60000

      - name: Smoke test deployed health endpoint
        run: curl --fail --show-error --silent "${{ steps.deploy.outputs.url }}/api/v1/health"
